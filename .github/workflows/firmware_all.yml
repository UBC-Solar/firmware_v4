name: Firmware All CI

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'firmware/**'
      - 'Makefile'
      - '.github/workflows/firmware.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'firmware/**'
      - 'Makefile'
      - '.github/workflows/firmware.yml'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        module: [mdi, tel]
        mode: [Debug, Release]
    
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build gcc-arm-none-eabi libnewlib-arm-none-eabi

      - name: Build ${{ matrix.module }} (${{ matrix.mode }})
        run: make ${{ matrix.module }} ${{ matrix.mode }}

      - name: Verify binary exists
        run: |
          ls -lh firmware/components/${{ matrix.module }}/build/**/*.elf || echo "Binary not found"

  unit-tests:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'

      - name: Install Ceedling
        run: gem install --no-document ceedling

      - name: Run MDI Unit Tests
        run: |
          cd firmware/components/mdi
          ./ceedling test:all

  build-all:
    runs-on: ubuntu-latest
    needs: [build, unit-tests]
    if: success()
    
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build gcc-arm-none-eabi libnewlib-arm-none-eabi

      - name: Build all modules (Debug)
        run: make all debug

      - name: Build all modules (Release)
        run: make all release

      - name: Summary
        run: |
          echo "✓ All modules built successfully"
          echo "✓ Unit tests passed"
          find firmware/components -name "*.elf" -type f